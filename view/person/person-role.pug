extends /layout/page

mixin row-selector(row, index)
  input.row-selector(
    type='checkbox'
    checked=row.personId !== null
    data-json=`{
      "wasChecked": ${row.personId !== null},
      "id": "${args.personId}",
      "roleName": "${row.roleName}",
      "roleLabel": "${row.roleLabel}"
    }`
  )

block content

  +form('Manage Person Roles')().ui-frame

    +menu('list:access.person:primary', null, { inline: true }).primary

    +menu('list:access.person:local', null, { inline: true, resource: result }).secondary

    label Role Label

    +input(
      name='roleLabel'
      type='text'
    )

    div.actions

      input(
        type='submit'
        value='Search'
      )

      a.button(
        href=request.uri
      ) Clear

  +form(
    'Role Changes',
    `${request.uri}?submitSuccess=true`
  )(method='post').ops.ui-frame.hidden

    block secondary-form

      div.create-inputs
      div.remove-inputs

      div(style='overflow-y: auto; padding: 2rem').row.ui-border.spaced.short
        div.col.half
          h4 Being Added
          pre.diff.create.success-color
        div.col.half
          h4 Being Removed
          pre.diff.remove.error-color

    div.inline.actions

      input(
        type='submit'
        value='Save'
      )

      a.button.clear() Clear

  +result-table(result, [
    ['hasRole', 'Enabled', { mixin: 'row-selector', selectAll: true }],
    ['roleLabel', 'Role'],
    ['isAdministrative', 'Is Administrative', { fmt: util.string.fmtYesNo }],
  ])

  +script.
    (($) => {
      owo.formDiffSelector({
        $opsForm: $('form.ops'),
        storageKey: `/person/#{args.id}/roles:selection`,
        keys: ['id', 'roleName'],
        entityName: 'personRole',
        dataToHtml: (data) => `<div>${data.roleLabel}</div>`,
      });
    })(jQuery)
